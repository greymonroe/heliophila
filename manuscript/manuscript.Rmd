---
title             : "Satellite-detected drought frequencies predict plant life history strategies"
shorttitle        : "Drought and life history"

author: 
  - name          : "J. Grey Monroe"
    affiliation   : "1,2"
    corresponding : yes    # Define only one corresponding author
    address       : "307 University Ave, Fort Collins, CO 80523"
    email         : "monroejg@colostate.edu"
  - name          : "Brian Gill"
    affiliation   : "3"
  - name          : "Kathryn Turner"
    affiliation   : "4"
  - name          : "John K. McKay"
    affiliation   : "2"
    
affiliation:
  - id            : "1"
    institution   : "Graduate Degree Program in Ecology, Colorado State University, Fort Collins, CO 80523, USA"
  - id            : "2"
    institution   : "College of Agriculture, Colorado State University, Fort Collins, CO 80523, USA"
  - id            : "3"
    institution   : "Institute for Environment and Society, Brown University, Providence, RI 02912, USA"
  - id            : "4"
    institution   : "Biology Department, Pennsylvania State University, State College, PA 16802, USA"    
    


abstract: Explaining variation in life history strategies is a long-standing goal of evolutionary biology. For plants, annual and perennial life histories are thought to reflect adaptation to environments that differ in the frequency of environmental stress such as drought. Here we test this hypothesis in \textit{Heliophila} (Brassicaceae), a diverse genus of flowering plants native to Southern Africa using herbarium occurrence records and satellite-detected drought histories. We find that perennial \textit{Heliophila} species are found in environments where droughts are significantly less frequent compared to annuals. These associations are predictive while controlling for phylogeny, lending support to the hypothesis that drought related natural selection has influenced the  distributions of these strategies. Additionally, the difference in drought frequency between annual and perennial species distributions is greatest during the summer and fall, which also appears to be when annuals are in the seed phase of their life cycle based on collection dates of annual species. Together, these findings support traditional hypotheses about the drivers of life history strategy in plants - that perenniality is favored in environments with less frequent drought and annuality in enviroments with more frequent drought by allowing them to escape drought prone seasons as seeds.

keywords          : "drought adaptation, life history evolution, remote sensing, phylogeography, herbaria records"

bibliography      : ["r-references.bib"]

floatsintext      : yes
figurelist        : no
tablelist         : no
footnotelist      : no
linenumbers       : yes
mask              : no
draft             : no
figsintext        : yes

documentclass     : "apa6"
classoption       : "man"
output            : papaja::apa6_pdf

header-includes   : 
  \newcommand{\beginsupplement}{\setcounter{table}{0}  \renewcommand{\thetable}{S\arabic{table}} \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}}

---

```{r setup, include = FALSE}
library("papaja")
library(raster)
library(tidyverse)
library(ggplot2)
library(logistf)
#library(gee) 
#library(phytools) 
library(geiger) 
library(ape) 
#library(caper) 
#library(MCMCglmm) 
library(phylolm)
library(gridExtra)
library(cowplot)
library(rasterVis)
library(ggtree)
library(grid)
library(png)
```

# Introduction

## Life history variation in plants

Understanding the causes and consequences of life history variation is a longstanding goal of ecology and evolutionary biology  [@cole1954population]. In plants, life histories are especially diverse, with herbaceous species that complete their life cycle in a number of weeks to trees that live for thousands of years [@brown1996oldlist]. Along this continuum an important division exists, distinguishing annuals (i.e. monocarpic or semelparous) which complete their seed to seed life cycle within a single calendar year from perennials (i.e. polycarpic or iteroparous] which can persist over multiple years. Annual plants flower once, set seed, senesce, and then die, spending at least some portion of the year as a seed. In contrast, perennial plants can continue vegetative growth after reproduction and experience all seasons. These represent fundamentally different life history strategies, but the ecological factors that explain their evolution remain uresolved [@friedman2015all]. 

Identifying the drivers of selection for these alternative strategies is important because annuals and perennials have differing impacts on ecosystem functioning. For example, perennials have higher nitrogen concentration and larger specific root length in annuals, which both affect nutrient cycling [@garnier1997specific; @roumet2006suites]. Furthermore, predicting the conditions that favor these strategies in nature is useful for developing more sustainable perennial cropping systems [@lelievre2009current].

Classical theory predict shorter life spans and annuality in environments where adult mortality is high [@charnov1973life; @stearns1992evolution;@franco1996life]. In plants, this has been extended to the hypothessis that annuality is adaptive when it allows plants to escape drought [@schaffer1975selection]. Lack of water is perhaps the greatest threat to survival during vegetatitive or reproductive growth and annuals can remain dormant (and protected as a seed) during drought. Thus, environments with greater seasonal drought frequency may select for annual life histories that complete reproduction prior to drought prone seasons. Conversely, environments with less frequent drought may select for perennial species, which may benefit from multiple bouts of reproduction and competitive advantage [@corbin2004competition]. These prediction has been supported by the association of annualilty with arid environments in wild rice [@morishima1984differentiation] and _Oenothera_ [@evans2005climate]. Additionally, annual and perennial species of Nemesia were qualitatively associated with winter rather and summer rainfall environments respectively [@datson2008climate] and annual species of Scorzoneroides were associated with environments classified as unpredictable [@cruz2009molecular]. These findings provide qualitative evidence supporting the prediction that annual species are found in environments that experience more frequent drought, and vice versa, but whether the history frequency of drought events indeed predicts the distributions annual or perennial life history strategies has yet to be tested. 

Here we combine a long-term global dataset of satellite detected drought events with metadata from natural collections to test these classic hypotheses about the evolution of life history strategies within the African endemic mustard genus, _Heliophila_ L. (Brassicaceae). If annuallity is an adaptive strategy allowing plants to escape drought prone seasons, then drought frequency should predict the distribution of life history strategies across landscapes, and annual species should be more commonly associated with drought prone regions than perennial species. Furthermore, if annual species have adapted to escape drought prone seasons as seeds, observations of annual species should be rare during drought prone seasons. Phylogenetic relatedness can have significant non-random effects on species distributions and life history traits [], and therefore we assessed the relationship between life history distribution and drought frequency in a phylogenetically controlled background.


# Materials and Methods

## Availability
All data and the source code to produce this manuscript are available at https://github.com/greymonroe/heliophila.

## Data
### Satellite-detected drought data
```{r Droughtdata}
Winter<-raster("../data/drought/Summer_drought_freq")
Spring<-raster("../data/drought/Fall_drought_freq")
Summer<-raster("../data/drought/Winter_drought_freq")
Fall<-raster("../data/drought/Spring_drought_freq")
```

Remotely sensed data is a powerful tool for characterizing seasonal patterns in drought because it is less limited in spatial and temporal scope and resolution than weather stations or field observations [@aghakouchak2015remote]. To quantify the frequency of drought during different seasons across landscapes, we used the remotely sensed Vegetative Health Index (VHI), which measures landscape scale reductions in plant cover and temperature conditions characteristic of drought [@kogan2001operational]. Generated from data collected by NOAA AVHRR satellites since 1981, the VHI combines normalized difference vegetation index (NDVI) derived measures of vegetative stress (Vegetative Condition Index - VCI) with temperature stress indicated by anomalies in thermal spectra (Temperature Condition Index - TCI). 

The VHI of year $y$ during week $w$ of $[1,52]$ at pixel $i$ is derived from the following equations, where $n$ is the number of years observed. 

$$VCI_{y,w,i} = 100\frac{NDVI_{y,w,i} - NDVI_{min}}{NDVI_{max} - NDVI_{min}}$$

where $NDVI_{min} = min(NDVI_{1981,w,i}...NDVI_{1981+n,w,i})$ and $NDVI_{max} = max(NDVI_{1981,w,i}...NDVI_{1981+n,w,i})$

$$TCI_{y,w,i} = 100\frac{T_{y,w,i} - T_{min}}{T_{max} - T_{min}}$$

where $T_{min} = min(T_{1981,w,i}...T_{1981+n,w,i})$ and $T_{max} = max(T_{1981,w,i}...T_{1981+n,w,i})$

$$VHI_{y,w,i} = 0.5(VCI_{y,w,i}) + 0.5(TCI_{y,w,i})$$

Thus, VHI measurements are standardized according to conditions historically observed at each locations. These measurements have been validated and generally used for evaluating drought risk and predicting crop yields in agriculture [e.g., @rojas2011assessing; @kogan2016modelling]. But they also present a tool to study seasonal patterns in the frequency of drought across environments and to test hypotheses about the effect of drought on ecological and evolutionary processes. Indeed, the VHI  has been applied recently to study drought related ecology of natural species and proven useful for predicting infraspecific variation in drought tolerance traits and genes [@Mojica2016;@dittberner2018natural;@monroe2018drought]. Here, we accessed VHI data at $16km^2$ resolution from 1981 to 2015 (https://www.star.nesdis.noaa.gov/smcd/emb/vci/VH/vh_ftp.php) to characterize the seasonal drought frequencies experienced by annual and perennial _Heliophila_ sepecies.

### Life history data for Heliophila
_Heliophila_ is a genus of flowering plants endemic to the southern portion of Africa including the Cape Floristic and Succulent Karoo Regions. These are among the most botanically diverse environments on Earth and the estimated ~50 _Heliophila_ species are considered to be the most diverse genus of the family Brassicaceae [@mummenhoff2005phylogeny]. This genus includes both perennial and annual species and this change in life history strategy has likely arisen multiple independent times [@appel1997generic;@mummenhoff2005phylogeny]. We used life histories reported by @mummenhoff2005phylogeny, grouping species with annual or perennial life histories. Perenniality was defined based on the traditional defition and included any form of perennial life history (e.g., herbs, shrubs, mixed, etc). 

### Heliophila herbarium specimens
```{r raw_GBIF}
GBIF<-read.csv("../data/0006178-160311141623029/occurrence.csv")
```
Botanists have collected and maintained over 350 million botanical specimens worldwide over the past 300 years. Herbarium specimens and their associated metadata have been used since the 1960s to study species’ geographical distributions (reviewed by  @willis2017old and @lang2018using). And as they become digitized [@soltis2017digitization], these collections have been used to study relationships between trait distributions, geography, and climate [@davis2015herbarium;@wolf2016altitudinal;@stropp2016mapping;@vaclavik2017effects]. To characterize the diributions of annual and perennial _Heliophila_ species, all records for the genus _Heliophila_ were downloaded from the Global Biodiversity Information Facility (gbif.org) on July 21, 2018.

### Sequence data for phylogeny
Aligned Heliophila ITS sequences were obtained from previous work by @mandakova2012whole.  Aethionema, Alliaria, Cardamine, Chamira, and Rorippa ITS records from were downloaded from Genbank [] and aligned together with Heliophila ITS sequences using MAFFT as outgroups []. 

## Analyses
### Drought frequency calculations

To characterize drought regimens across the distrubtions of annual and perennial species of _Heliohpila_, we calculated drought during different seasons at the location of observations for _Heliophila_ records using the VHI. Specifically, we created global maps of the frequencies of observing drought conditions (VHI<40, NOAA) during the winter (quarter surrounding winter solstice), spring (quarter surrounding spring equinox), summer (quarter surrounding summer solstice) and fall (quarter surrounding fall equinox) from 1981 to 2015. From these maps, the drought frequency during the winter, spring, summer, and fall were extracted for the locations of all GBIF records.

### Herbarium record quality control
```{r cleanup}
species_life_history<-read.csv("../data/Heliophila_life_history.csv")
species_life_history$species<-gsub("_", " ", species_life_history$species)
species_life_history$species <- as.factor(species_life_history$species)

GBIF <- GBIF %>%
  mutate(Winter=raster::extract(Winter, cbind(decimalLongitude, decimalLatitude))) %>%
  mutate(Spring=raster::extract(Spring, cbind(decimalLongitude, decimalLatitude))) %>%
  mutate(Summer=raster::extract(Summer, cbind(decimalLongitude, decimalLatitude))) %>%
  mutate(Fall=raster::extract(Fall, cbind(decimalLongitude, decimalLatitude))) %>%
  mutate(ymd_lat_lon_sp = paste0(year,"_",month,"_",day,"_", decimalLatitude,"_", decimalLongitude,"_", species))
  
GBIF_cleaned <- GBIF %>%
  filter(species %in% species_life_history$species) %>% 
  filter(!is.na(decimalLatitude)) %>%
  filter(hasGeospatialIssues==FALSE) %>%
  filter(decimalLatitude<(-20)) %>%
  filter(decimalLongitude<40) %>%
  filter(!duplicated(ymd_lat_lon_sp)) %>%
  merge(species_life_history) %>%
  filter(!is.na(Summer))
```

To remove instance with spurious location data, we filtered raw GBIF by restricting our analyses to include only:  
* Species with reported life history  
* Records with geospatial data  
* Records without known geospatial issues  
* Records from collection sites classified as land pixels   
* Records from Africa  
* Non-duplicate records (ie. identical species, location, collection date)  

### Phylogeny construction
Model selection for construction of phylogeny was performed in jModeltest2 with CIPRES (cite).  Based on this analysis, $GTR + L$ were selected. Ultrametric phylogeny was estimated with branch lengths as relative time (details). 

### Comparison of drought frequency between annual and perennial
```{r speciesmeans}
species_means <- GBIF_cleaned %>%
  dplyr::select(species, life_history, Winter, Summer, Spring, Fall) %>%
  group_by(species, life_history) %>%
  summarise(n=n(), Winter_mean=mean(Winter), Spring_mean=mean(Spring), Summer_mean=mean(Summer), Fall_mean=mean(Fall)) %>% 
  as.data.frame()

```
```{r firthmodels, echo=F,  results="hide"}

firthmodelstable<-data.frame()

# non-phylogenetic logistic regression firth penalized
species_means$life_history_num<-as.numeric(species_means$life_history)-1
row.names(species_means)<-gsub(" ", "_", species_means$species)
seasons<-c("Winter_mean", "Spring_mean", "Summer_mean","Fall_mean")
for(s in 1:length(seasons)){
  fit1 <- logistf(species_means$life_history_num~(species_means[,seasons[s]]), firth = TRUE)
  sum<-summary(fit1)
  row.names(sum$coefficients)<-NULL
  sum_df<-data.frame(Predictor=c("Intercept", gsub("_mean", " drought freq.", seasons[s])), 
                     Estimate=sum$coefficients, 
                     p.value=sum$prob)
  row.names(sum_df)<-NULL
  firthmodelstable<-rbind(firthmodelstable, sum_df)
}


```
```{r phylomodels, results="hide"}
# phylogentic constraint
tree<-read.nexus("../data/TrimmedMCCwoPolytomies.nex")
tree<- rescale(tree, "depth", 1)

phylomodelstable<-data.frame()

for(s in 1:length(seasons)){
  fit1 <-  phyloglm(species_means$life_history_num~species_means[,seasons[s]], data=species_means, phy=tree)
  sum<-summary(fit1)
  row.names(sum$coefficients)<-NULL
  sum_df<-data.frame(Predictor=c("Intercept", gsub("_mean", " drought freq.", seasons[s])), sum$coefficients)
  phylomodelstable<-rbind(phylomodelstable, sum_df)
}

phylomodelstable <- phylomodelstable[,c( "Predictor","Estimate","p.value")]

```
To evaluate the hypothesis that annual and perennial life history strategies reflect adaptations to alternative drought regimes, we tested the corresponding prediction that the observed distributions of annual and perennial _Heliophila_ species would be significantly associated with historic drought frequency.  The relationship between drought frequencies across each taxon’s range and life habitat (annual or perennial) was evaluated using Firth's penalized-likelihood logistic regression and phylogenetic logistic regression.

### Collection dates

To test the hypothesis that annual species have adapted to escape drought prone seasons as seeds, collection dates for herbarium specimens were compared between annual and perennial species. Comparisons of distributions were made by Two-sample Kolmogorov-Smirnov test, t-test, and Barlett variance test.

# Results

To test the hypothesis that annual and perennial plants reflect adaptation to alternative drought environments we examined the landscape distribution of life history strategies in the large and diverse mustard genus, _Heliophila_ Figure \@ref(fig:phylogeny). Using both herbarium specimen metadata and a 30 year dataset of satellite generated climate information, we tested the prediction that annual species  are more often observed in drought-prone locations than perennial species, when controlling for phylogenetic relatedness. We found that drought frequency is significantly different between the distributions of annual and perennial species, with annuals being found in environments with significantly more frequent drought, and that this signal is strongest during the summer. These results remain significant while controlling for the phylogenetic relationships of Heliophila species, yielding support for the role that natural selection has played in driving contemporary distributions of these alternatives strategies in relation to drought regimes. 

(ref:phylogeny) Phylogeny of Heliophila. 

```{r makephylogeny, eval=T, message=F, warning="hide", results="hide"}

pdf("../figures/phylogeny.pdf", height=6, width=5)

tree<-read.nexus("../data/TrimmedMCCwoPolytomies.nex")
tree<- rescale(tree, "depth", 1)
tree$tip.label<-gsub("_"," ", tree$tip.label)

treeplot<-ggtree(tree, layout = "rectangular")+
  xlim(c(0,2))+
  geom_tippoint(size=3,col=ifelse(species_life_history$life_history[match(tree$tip.label,species_life_history$species)]=="a", "orange3", "dodgerblue3"))+
  geom_tiplab(offset = .05 , size=3)

minima <- readPNG("../pictures/minima.png")
minima <- rasterGrob(minima, interpolate=TRUE)
#https://www.gbif.org/occurrence/1099023487

deserticola <- readPNG("../pictures/deserticola.png")
deserticola <- rasterGrob(deserticola, interpolate=TRUE)
#https://www.gbif.org/occurrence/1057389408

coronopifolia<-readPNG("../pictures/coronopifolia.png")
coronopifolia <- rasterGrob(coronopifolia, interpolate=TRUE)
#https://www.gbif.org/occurrence/1099023562

ephemera<-readPNG("../pictures/ephemera.png")
ephemera <- rasterGrob(ephemera, interpolate=TRUE)
#https://www.gbif.org/occurrence/1099023490

pics<-plot_grid(minima, deserticola, coronopifolia, ephemera,
                labels = c("b","c","d","e"), ncol = 1)

plot_grid(treeplot, pics, ncol=2,labels=c("a",""), rel_widths = c(1,0.3))


dev.off()


```
```{r phylogeny, fig.cap='(ref:phylogeny)', out.width = "\\textwidth", fig.pos = "!h"}
knitr::include_graphics("../figures/phylogeny.pdf", dpi = 108)
```

### GBIF records 

Out of `r nrow(GBIF)` _Heliophila_ GBIF recrods,  `r sum(GBIF$species %in% species_life_history$species)` were for species with reported life history [@mummenhoff2005phylogeny], `r sum(!is.na(GBIF$decimalLatitude))` had geospatial data, `r sum(!(GBIF$hasGeospatialIssues==T) & !(is.na(GBIF$decimalLatitude)))` did not have geospatial issues, `r sum(!(is.na(GBIF$Summer)) & !(is.na(GBIF$decimalLatitude)))` were located on pixels classified as land having drought measurements, `r sum(GBIF$decimalLatitude < (-20) & GBIF$decimalLongitude < (40) & !is.na(GBIF$decimalLatitude))` were located in Africa, `r sum(!duplicated(GBIF$ymd_lat_lon_sp) & !is.na(GBIF$decimalLatitude)) ` were not duplicated. After all filtering steps, `r nrow(GBIF_cleaned)` records for `r length(unique(GBIF_cleaned$species))` species (Figure \@ref(fig:mapsboxplots), Table \@ref(tab:speciesmeanstable)) passed. 



### Drought frequency  

Drought frequency was signicantly different between annual and perennial species.  

(ref:mapsboxplots) Locations of annual and perennial Heliophila. Drought frequency during the winter, spring, summer and fall. Drought frequencies during each season observed at the collection sites of Heliophila records.

```{r make_maps_boxplots, eval=T, message=F, results="hide"}


pdf("../figures/maps_boxplots.pdf", width=5, height=7.5)
world <- map_data("world") # we already did this, but we can do it again
library(cowplot)

perennialmap<-ggplot() + geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  geom_point(GBIF_cleaned %>% filter(life_history=="p"), mapping=aes(x=decimalLongitude, y=decimalLatitude), pch=3, col="dodgerblue3", alpha=0.3) +
  theme_classic()+
  theme( text = element_text(size=8))+
  labs(title="Perennial species", x="Longitude (°)", y="Latitude (°)")+
  annotate("text", x=32, y=-34, label=paste("n obs. =", nrow(GBIF_cleaned %>% filter(life_history=="p"))), size=2)

annualmap<-ggplot() + geom_polygon(data = world, aes(x=long, y = lat, group=group),  lwd=.5, fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  geom_point(GBIF_cleaned %>% filter(life_history=="a"), mapping=aes(x=decimalLongitude, y=decimalLatitude), pch=3, col="orange3", alpha=0.3) +
  theme_classic()+
  theme(text = element_text(size=8))+
  labs(title="Annual species", x="Longitude (°)", y="Latitude (°)")+
  annotate("text", x=32, y=-34, label=paste("n obs. =", nrow(GBIF_cleaned %>% filter(life_history=="a"))), size=2)



Winter_SA <-crop(Winter, rbind(c(12,37),c(-35, -18)))

wintermap<-gplot(Winter_SA) + 
  geom_tile(aes(fill=value)) + 
  scale_fill_gradientn(colors=c( 'white',"gray80", "gray20", 'black'), na.value="white", name=NULL) +
  geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  theme_classic()+
  theme(legend.position = c(0.95,.3),legend.text=element_text(size=rel(0.7)), legend.key.size=unit(.5,"line"), legend.background = element_rect(fill=alpha('white', 0)), text = element_text(size=8))+
  labs(title="Winter drought freq.", x="Longitude (°)", y="Latitude (°)")

Spring_SA <-crop(Spring, rbind(c(12,37),c(-35, -18)))

springmap<-gplot(Spring_SA) + 
  geom_tile(aes(fill=value)) + 
  scale_fill_gradientn(colors=c( 'white',"gray80", "gray20", 'black'), na.value="white", name=NULL) +
  geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  theme_classic()+
  theme(legend.position = c(0.95,.3),legend.text=element_text(size=rel(0.7)), legend.key.size=unit(.5,"line"), legend.background = element_rect(fill=alpha('white', 0)), text = element_text(size=8))+
  labs(title="Spring drought freq.", x="Longitude (°)", y="Latitude (°)")

Summer_SA <-crop(Summer, rbind(c(12,37),c(-35, -18)))

summermap<-gplot(Summer_SA) + 
  geom_tile(aes(fill=value)) + 
  scale_fill_gradientn(colors=c( 'white',"gray80", "gray20", 'black'), na.value="white", name=NULL) +
  geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  theme_classic()+
  theme(legend.position = c(0.95,.3),legend.text=element_text(size=rel(0.7)), legend.key.size=unit(.5,"line"), legend.background = element_rect(fill=alpha('white', 0)), text = element_text(size=8))+
  labs(title="Summer drought freq.", x="Longitude (°)", y="Latitude (°)")

Fall_SA <-crop(Fall, rbind(c(12,37),c(-35, -18)))

fallmap<-gplot(Fall_SA) + 
  geom_tile(aes(fill=value)) + 
  scale_fill_gradientn(colors=c( 'white',"gray80", "gray20", 'black'), na.value="white", name=NULL) +
  geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  theme_classic()+
  theme(legend.position = c(0.95,.3),legend.text=element_text(size=rel(0.7)), legend.key.size=unit(.5,"line"), legend.background = element_rect(fill=alpha('white', 0)), text = element_text(size=8))+
  labs(title="Fall drought freq.", x="Longitude (°)", y="Latitude (°)")

GBIF_cleaned_long<- GBIF_cleaned %>%
  dplyr::select(species, life_history, Winter, Spring, Summer,Fall) %>%
  gather(season, drought_freq, Winter, Spring, Summer,Fall)

GBIF_cleaned_long$season<-factor(GBIF_cleaned_long$season, levels=c("Winter","Spring","Summer","Fall"))

boxplots<-ggplot(GBIF_cleaned_long, aes(x=life_history, col=life_history, y=drought_freq))+
  facet_wrap(~season, ncol=4 )+
  geom_jitter(width = .3, alpha=0.1, pch=3)+
  geom_boxplot(outlier.colour = "white", outlier.fill = "white", fill=NA, width=.3)+
  scale_color_manual(values=c("orange3","dodgerblue3"))+
  theme_classic()+
  theme(legend.position = "none", text = element_text(size=8))+
  scale_x_discrete(name="Life history", labels=c("Annual","Perennial"))+
  labs(y="Drought frequency")



maps<-plot_grid(annualmap, 
          perennialmap, 
          wintermap, 
          springmap,
          summermap,
          fallmap, 
          labels = "auto", ncol = 2)
plot_grid(maps, boxplots, ncol=1,labels=c("","g"), rel_heights = c(.75,.35))


dev.off()

```

```{r mapsboxplots, fig.cap='(ref:mapsboxplots)', out.width = "\\textwidth", fig.pos = "!h"}
knitr::include_graphics("../figures/maps_boxplots.pdf", dpi = 108)
```

```{r modelstable, results = 'asis', echo = F}

modelstable<-bind_cols(firthmodelstable,phylomodelstable)

modelstable<- modelstable %>%
  dplyr::select(Predictor, Estimate, p.value,Estimate1, p.value1) 

colnames(modelstable)<-c("Predictor", "Estimate`","P`","Estimate*","P*")

apa_table(modelstable
  , caption = "Logistic regressions between life history, and the mean drought frequency observed at herbaria collection sites of Heliophila species the winter, spring, summer, and fall."
  , note = "` = Firth's penalized logistic regression. * = Phylogenetically constrained logistic regression. Annual species were scored as 0 and perennial species as 1.",
  midrules=c(2,4,6,8),
  digits=4
)

```


### Collection dates


(ref:lineplots) Comparison (mean +- SE) of drought frequency across seasons measured at the GBIF records of annual and perennial species of Heliophila. (B) Collection dates of GBIF records of annual and perennial species of Heliophila. 

```{r makelineplots, eval=T, message=F, results="hide"}


pdf("../figures/line_and_dates.pdf", height=5, width=5)

life_history_drought_means<- species_means %>% 
  dplyr::select(life_history, Winter_mean, Spring_mean, Summer_mean,Fall_mean)  %>%
  gather(variable, value, -life_history) %>%
  group_by(life_history, variable) %>%
  summarise(mean = mean(value), se = sd(value)/sqrt(length(value))) %>%
  mutate(variable = reorder(variable, c(4,2,3,1)))

lines<-ggplot(life_history_drought_means, aes(x=variable, col=life_history,group=life_history, y=mean))+
  theme_classic()+
  geom_point(size=2)+
  geom_line(lwd=0.5, lty=1)+
  geom_errorbar(width=0.25,lwd=1, aes(ymin=mean-se, ymax=mean+se))+
  scale_y_continuous(limits=c(0.3,0.45), labels = c("0.300", "0.350", "0.400", "0.450"))+
  scale_x_discrete(labels=c("Winter","Spring","Summer","Fall"))+
  scale_color_manual(values=c( "orange3","dodgerblue3"), name="Life history", labels=c("Annual", "Prennial"))+
  labs(x="Season", y="Drought Frequency")+
  annotate("text", x=2, y=0.44, label="*", size=7) +
  annotate("text", x=3:4, y=0.44, label="**", size=7)

GBIF_cleaned$date_calc<-as.Date(paste(
  GBIF_cleaned$month,
  GBIF_cleaned$day, sep="-"),"%m-%d")
GBIF_cleaned$days<-lubridate::yday(GBIF_cleaned$date_calc)
GBIF_cleaned$days_adjusted<-sapply(GBIF_cleaned$days, function(x)
  if(is.na(x)){ return(NA)
  }else if(x>135) {
    return (x-135)
  }else return (x+230))


dates<-ggplot(GBIF_cleaned %>% filter(is.finite(days_adjusted)), aes(x=days_adjusted, fill=life_history)) +
  geom_density(alpha=.5)+
  scale_fill_manual(values=c("orange3","dodgerblue3"), name="Life history", labels=c("Annual", "Perennial"))+
  theme_classic()+
  scale_x_continuous(name="Season", breaks=c(45,135,225, 315), labels=c("Winter","Spring","Summer","Fall"))+
  labs(title="Collection date\nof herbaria specimens", y="Density")+
  theme(plot.title = element_text(hjust = 0.5))

plot_grid(lines, dates, ncol=1, labels="auto")

annuals<-subset(GBIF_cleaned, life_history=="a")
perennials<-subset(GBIF_cleaned, life_history=="p")

#ks.test(annuals$days,perennials$days)
t.test(days~life_history, GBIF_cleaned)
bartlett.test(days~life_history, GBIF_cleaned)

dev.off()

```

```{r lineplots, fig.cap='(ref:lineplots)'}
knitr::include_graphics("../figures/line_and_dates.pdf", dpi = 108)
```


# Discussion
## Summary
We found that the distribution of annual and perennial species of Heliophila is significantly predicted by satellite detected historic drought frequencies. Annual species are found in environments that experience more frequent drought during the summer and fall quarters compared to perennials. This relationship was consistent while controlling for phylogenetic relatedness among the taxa studied, indicating that these distributions cannot be explained entirely by common ancestry. These results support the hypothesis that natural selection has played a role in shaping the contemporary distributions of these alternative life-history strategies.  

## Relationship to previous hypotheses/work

Herbaria records and satellite detected drought provide data with which the distributions of annual and perennial species can be compared with respect to historic drought frequency. However, it is necessary to control for the demographic history caused by common ancestry of species if evolutionary processes such as natural selection are to be invoked as explanations for any differences observed. If, for example, annual and perennial species show significantly different ranges with respect to historic drought this could be confounded by common ancestry if annuals originated from a common ancestor and vice versa. In this case, it would be challenging to distinguish between natural selection and demographic history. On the other hand, if annual and perennial life history strategies arose independently in multiple species, controlling for phylogenetic relationships allows us to better account for demography and make stronger assertions about the importance of processes such as natural selection to explain patterns. 

These findings support classical theoretical predictions about the adaptive value of annual and perennial life history strategies. Taken together, they suggest that in Heliophila, annual species are adapted to environments with increased summer droughts by avoiding these seasons in a dormant seed phase of their life cycle. Indeed, we found that very few annuals are collected during this season, supporting the prediction that they are not in a vegetative and/or reproductive phase at this time. Traditionally, the focus has been on the evolutionary origins of annual life histories {citations}. However, we also find evidence that the transition to perenniality could be explained by historical drought regimes. The phylogeny reveals several transitions from annual to perennial life history. Perennials may be able to out complete annual relatives in environments where the infrequency of drought favors strategies that allow plants to benefit from growth over many seasons.

## Caveats
Sampling bias [@daru2018widespread].
Correlation does not prove causation. But it does indicate predictive power and is consistent with adaptive hypotheses.
Herbarium collections and their associated data do not represent systematic or random sampling of a species distribution. Significant biases in collecting exist, which we have not necessarily controlled for here, and may have some effect on our findings, such as a bias toward collecting near roads or near the locations of natural history collections (Daru et al. 2018, Heberling, in press). Despite these biases, the Cape Floristic region is a biodiversity hotspot and one of the most botanically well sampled regions on Earth (Daru et al. 2018, Heberling, in press?), suggesting that this may currently be the optimal region for our analyses of life history distribution. Future research will benefit from systematic sampling efforts to avoid these noted biases.
The climate data used here are assessed only from 198X-XXXX and do not reflect conditions at the estimated divergence dates of these species (XXX million of years ago).  Rather, the results suggest that the current distributions of annual and perennial species reflect a history of environmental filtration and ongoing natural selection. That is, their distributions are non-random with respect to historic drought and this is not explained by phylogeny.

## Broader implications 
These findings suggest that rapidly changing drought regimes threaten species adapted to current environments.  Studies predict changing drought regimes.  This could have impacts on ecosystem functioning. This should also be considered when thinking about using perennial crops. Studies predict changing drought regimes. 

Do annuals require drought? We found independent origins of perenniality in environments where droughts are infrequent. Annuals may not be able to compete with perennials in the absence of droughts. 

## Conclusions 
Perenniality appears to be adaptive in environments with less frequent drought. This work demonstrates the power of emerging data to address outstanding classic hypotheses in ecology and evolution.

# Acknowledgments 
This work was supported by NSF no. USDA grant no. XXX to J.G.M.


# References
\newpage
```{r create_r-references}
#r_refs(file = "r-references.bib")
```
\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id = "refs"></div>
\endgroup

\newpage
\beginsupplement

# Supplement 

### Software used
We used `r cite_r("r-references.bib")` for all our analyses.

### Supplementary tables and figures
```{r speciesmeanstable, results = 'asis', echo = F}
species_means_table<-species_means
row.names(species_means_table) <- NULL
species_means_table<-species_means_table %>% dplyr::select(-life_history_num)
colnames(species_means_table)<-c("Species","LH","n","Winter","Spring","Summer","Fall")
apa_table(
  species_means_table
  , caption = "Heliophila species records and the mean drought frequencies during different seasons at the location of records "
  , note = "LH = Life history (a = annual, p = perennial). n=sample size of GBIF records. Seasons are mean drought frequencies observed at locations of records.",
  digits=2,
  font_size="small",
  longtable = TRUE
)
```
