---
title             : "Drought regimens predict life history strategies in _Heliophila_"
shorttitle        : "Drought and life history"

author: 
  - name          : "J. Grey Monroe"
    affiliation   : "1,2"
    corresponding : yes    # Define only one corresponding author
    address       : "307 University Ave, Fort Collins, CO 80521"
    email         : "monroejg@colostate.edu"
    phone         : "919-810-8800"
    orcid         : 0000-0002-4025-5572
    twitter       : "@Grey_Monroe"
  - name          : "Brian Gill"
    affiliation   : "3"
    twitter       : "@BrianGillPhD"
    orcid         : 0000-0001-9567-8989
  - name          : "Kathryn G. Turner"
    affiliation   : "4"
    twitter       : "@KTInvasion"
    orcid         : 0000-0001-8982-0301
  - name          : "John K. McKay"
    affiliation   : "2"
    orcid         : 0000-0003-4311-5513
    
affiliation:
  - id            : "1"
    institution   : "Graduate Degree Program in Ecology, Colorado State University, Fort Collins, CO 80521, USA"
  - id            : "2"
    institution   : "College of Agriculture, Colorado State University, Fort Collins, CO 80521, USA"
  - id            : "3"
    institution   : "Institute for Environment and Society, Brown University, Providence, RI 02912, USA"
  - id            : "4"
    institution   : "Biology Department, Pennsylvania State University, State College, PA 16802, USA"    
    


abstract: \begin{center}\textbf{Summary}\end{center} \par Explaining variation in life history strategies is an enduring goal of evolutionary biology and ecology. Early theory predicted that for plants, annual and perennial life histories reflect adaptation to environments that experience alternative drought regimens. Nevertheless, empirical support for this hypothesis from comparative analyses remains lacking. \par Here, we test classic life history theory in \textit{Heliophila} (Brassicaceae), a diverse genus of flowering plants native to Africa, controlling for phylogeny and integrating 34 years of satellite-based drought detection with 2,192 herbaria occurrence records. \par We find that the common ancestor of \textit{Heliophila} species was likely an annual, and that perenniality and annuality have repeatedly evolved, an estimated seven and five times, respectively. By comparing historical drought regimens, we show that annuals occur in environments where droughts are significantly more frequent than perennial species. We also provide evidence that annual plants adapt to predictable drought regimens by escaping drought prone seasons as seeds. \par These results yield compelling support for longstanding theoretical predictions by revealing the importance of drought frequency and predictability to explain plant life history. More broadly, this work highlights scalable approaches integrating herbaria records and remote sensing to address outstanding questions in evolutionary ecology.

keywords          : "drought adaptation, herbaria records, Heliophila, life history evolution, phylogeography, remote sensing"

bibliography      : ["r-references.bib"]
csl               : mycsl.csl

floatsintext      : yes
figurelist        : no
tablelist         : no
footnotelist      : no
linenumbers       : yes
mask              : no
draft             : no
figsintext        : yes

documentclass     : "apa6"
classoption       : "man"
output            : papaja::apa6_word

header-includes   : 
  \newcommand{\beginsupplement}{\setcounter{table}{0}  \renewcommand{\thetable}{S\arabic{table}} \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}}

---

```{r setup, include = FALSE}
library("papaja")
library(raster)
library(tidyverse)
library(ggplot2)
library(logistf)
library(geiger) 
library(ape) 
library(phylolm)
library(gridExtra)
library(cowplot)
library(rasterVis)
library(ggtree)
library(grid)
library(png)
library(ggimage)
library(lmerTest)
library(lme4)
library(emmeans)
```
# Introduction

Understanding the causes of life history variation and climate adaptation are longstanding goals of ecology and evolutionary biology  [@raunkiaer1905types;@turesson1925plant;@clausen1948experimental;@cole1954population]. In  plants, life histories are especially diverse, with some species completing their life cycle in a number of weeks to others that live for thousands of years [@brown1996oldlist]. Along this continuum in angiosperms an important division exists distinguishing annuals which complete their seed to seed life cycle within a single year from perennials which can persist over multiple years. Annual plants do not need to survive through the full range of seasonal environmental variation and spend at least some portion of the year as a seed where they are relatively protected from environmental stress. In contrast, perennial plants can continue vegetative growth over multiple years and must survive conditions experienced during all seasons but can also benefit from competitive advantages and, if iteroparous, multiple bouts of reproduction. These represent fundamentally different life history strategies and predicting their occurrence is important for community, ecosystem, and agricultural ecology. However, the environmental factors that explain their evolution and distributions remain empirically unresolved [@friedman2015all].  

Classical theory predicts shorter life spans in environments where adult mortality is high [@charnov1973life;@stearns1992evolution;@franco1996life]. Because lack of water is one of the greatest threats to survival during vegetative or reproductive growth in plants, this theory has been extended to the hypothesis that annuality is adaptive when it allows plants to escape drought [@cody1975ecology;@schaffer1975selection]. Indeed, adaptation to drought,  defined as episodes of increased aridity causing plant stress [@passioura1996drought], is often invoked as an explanation for the success of annual species, though drought adapted perennials are also well known [@raunkiaer1905types]. And while a few cases are cited where annuality appears to be more common in environments with greater aridity [@stebbins1952aridity; @morishima1984differentiation], this hypothesis has yet to be supported while controlling for the effect of common ancestry (phylogeny) on life habit. In one previous study where this question was addressed phylogenetically,  [@evans2005climate] annuals were not found to be associated with environments that experience more drought. This could be explained by the relatively small number of species studied and the reliance on a limited number of weather stations to characterize environments, highlighting the need to develop more scalable methods to study the geographic distributions of traits such as life history. Thus, in this study we leverage thousands of herbaria specimens among dozens of species and high-resolution remote sensing to study the distributions and environmental factors potentially driving the evolution and distribution of life history. 

It is also critical to consider another dimension of drought adaptation: the expectation that annuality is most adaptive when droughts are not only frequent but also predictable. That is, when the frequency of drought is particularly high during certain seasons. Such predictability is important for selection to favor an escape strategy during those seasons which are particularly drought prone. While there has been at least one example of annuality associated with environments qualitatively classified as "predictable" in a general sense [@datson2008climate], the seasonal predictability of drought experienced by annuals has yet to be rigorously studied. As such, further empirical work is needed to support the model of annuality as a mechanism of drought adaptation via escape from drought prone seasons. Here we examine herbarium collection dates to ask whether annuals indeed exhibit evidence of an escape strategy from seasons with elevated drought frequency.

In addition to drought escape in annuals as a mechanism of adaptation to frequent and predictable droughts, droughts may be necessary for the success of annuals more generally by acting as episodes of disturbance that provide opportunities for annuals to establish and compete with sympatric perennial species. Indeed, there is evidence that perennials dominate in environments where disturbance events are infrequent [@rees1992germination;@corbin2004competition;@clary2012determinants]. The resulting prediction from this hypothesis is that in the absence of frequent drought, perenniality should evolve. However, little is known about this component of life history evolution because previous work has almost entirely focused on the origins of annuality rather than perenniality [@friedman2015all]. This highlights the need to study taxa which have seen transitions from annual to perennial life histories as well.

Here we combine a long-term global dataset of satellite detected drought events with metadata from natural history collections to test these classic hypotheses within the African endemic mustard genus, _Heliophila_ L. (Brassicaceae). If annuality is an adaptive strategy allowing plants to escape drought prone seasons, then drought frequency should predict the distribution of life history strategies across landscapes, and annual species should be more commonly associated with drought prone regions than perennial species. Additionally, if perenniality offers competitive advantage in the absence of drought, associations between life history and drought frequency should be significant when phylogenies include transitions from annual to perennial life history strategy. Finally, if annual species have adapted to escape predictably drought prone seasons, observations of growing annual species (i.e. occurring in forms other than seed) should be rare during seasons when drought frequency is highest. Phylogenetic relatedness can influence tests of associations between speciesâ€™ traits and their environments by confounding common environments caused by selection from common environments caused by ancestry. [@barrett1996comparative;@felsenstein1985phylogenies]. Therefore, we assessed the relationship between life history distribution and drought frequency while controlling for phylogeny. 

# Materials and Methods
## Data  
### Data availability
All analyses were performed using R. All data and the source code to produce this manuscript are available at https://github.com/greymonroe/heliophila. 

### Life history data for _Heliophila_
_Heliophila_ is a genus of flowering plants endemic to  southern Africa including the Cape Floristic and Succulent Karoo Regions. These are among the most botanically diverse environments on Earth and the _Heliophila_ species occurring there are considered to be among the most phenotypically diverse genera of the family Brassicaceae [@mummenhoff2005phylogeny;@mandakova2012whole]. This genus includes both perennial and annual species, and transitions between life history strategy may have occurred multiple independent times [@appel1997generic;@mummenhoff2005phylogeny]. Furthermore, the fine scale climatic heterogeneity of southern Africa is ideal for studying the distribution of traits in relation to environmental parameters [@sayre2013new]. We used life histories reported by @mummenhoff2005phylogeny, grouping species into annual or perennial life history categories. Perenniality was defined as any form of perennial life history (e.g., herbs, shrubs, mixed, etc). Because the nature of species reported with mixed traits were unknown (i.e. plasticity vs. genetic variation), we classified these species here as perennial since they can maintain vegetative across multiple years at least to some capacity.

### _Heliophila_ occurrence records
```{r raw_GBIF}
GBIF<-read.csv("../data/0006178-160311141623029/occurrence.csv")
```
To characterize the distributions of annual (studied here, n = 21) and perennial (studied here, n = 21) _Heliophila_ species, all (`r nrow(GBIF)`) records for the genus _Heliophila_ were downloaded from the Global Biodiversity Information Facility (gbif.org) on July 21, 2018 [@gbifdownload]. Herbaria records such as these provide a rich data sources to characterize the geographical distributions of species [@thiers2016index; @willis2017old; @lang2019using]. And as they become digitized [@soltis2017digitization], herbaria collections have been used to study relationships between trait distributions, geography, and climate [@davis2015herbarium;@wolf2016altitudinal;@stropp2016mapping;@vaclavik2017effects]. 

### Sequence data for phylogeny
An alignment of ITS I and II sequences for 21 annual and 21 perennial _Heliophila_ species was obtained from the authors of @mandakova2012whole. Individual ITS I and II sequences for _Aethionema grandiflorum, Alliaria petiolata, Cardamine matthioli, Chamira circaeoides_, and _Rorippa amphibia_ were downloaded from Genbank.

```{r Droughtdata}
Winter<-raster("../data/drought/Summer_drought_freq")
Spring<-raster("../data/drought/Fall_drought_freq")
Summer<-raster("../data/drought/Winter_drought_freq")
Autumn<-raster("../data/drought/Spring_drought_freq")

```

### Satellite-detected drought data

Remotely sensed data is a powerful tool for characterizing seasonal patterns in drought because it is less limited in spatial and temporal scope and resolution than weather stations or field observations [@aghakouchak2015remote]. From an ecological perspective, droughts are best defined as episodes of plant stress caused by elevated aridity [@passioura1996drought]. Thus remote sensing offers the additional benefit for studying drought as an agent of natural selection because plant stress caused by drought can be observed from space [@kogan1995droughts]. The remotely sensed Vegetative Health Index (VHI) is one such metric, which detects landscape scale reductions in plant cover and temperature conditions characteristic of drought [@kogan2001operational]. Generated from data collected by NOAA AVHRR satellites since 1981, the VHI is a composite index combining Normalized Difference Vegetation Index (NDVI) derived quantification of vegetative stress (Vegetative Condition Index - VCI) with temperature stress indicated by anomalies in thermal spectra (Temperature Condition Index - TCI). These indices were developed to create an unbiased quantification of drought across ecosystem types. The VHI of year $y$ during week $w$ of $[1,52]$ at pixel $i$ is derived from the following equations, where $n$ is the number of years observed. 

$$VCI_{y,w,i} = 100\frac{NDVI_{y,w,i} - NDVI_{min,w,i}}{NDVI_{max,w,i} - NDVI_{min,w,i}}$$

Low values of VCI indicate episodes when plant cover is particularly low for a given location during a given time of the year. Thus, it controls for the location and season in quantifying plant stress.  

$$TCI_{y,w,i} = 100\frac{T_{max,w,i}-T_{y,w,i}}{T_{max,w,i} - T_{min,w,i}}$$
Similarly, low TCI values indicate episdoes of high thermal stress shown to be negatively correlated with precipitation and soil moisture [@aghakouchak2015remote].

$$VHI_{y,w,i} = 0.5(VCI_{y,w,i}) + 0.5(TCI_{y,w,i})$$
By combining VCI and TCI, the VHI distinguishes drought from other forms of vegetative stress [@kogan1995application]. The use of the VHI to detect drought has been validated globally and across ecosystem types [@aghakouchak2015remote], including in southern Africa, the focal region of this study (e.g. Figure \@ref(fig:mapsdroughtexamples)). To date, the VHI has most often been applied for evaluating drought risk for agricultural research [e.g., @rojas2011assessing; @kogan2016modelling]. But it also presents a tool to study seasonal patterns in the frequency of drought across environments and to test hypotheses about the effect of drought on ecological and evolutionary processes [@kerr2003space]. As such, the VHI  has been applied recently to study drought related ecology of natural species and proven useful for predicting intraspecific variation in drought tolerance traits and genes [@mojica2016genetics;@dittberner2018natural;@monroe2018drought]. Here, we accessed VHI data at $16km^2$ resolution from 1981 to 2015 (https://www.star.nesdis.noaa.gov/smcd/emb/vci/VH/vh_ftp.php) to characterize the seasonal drought frequencies experienced by annual and perennial _Heliophila_ species across their native range of southern Africa. 

## Analyses
### Drought frequency calculations
To characterize drought regimens across the distributions of annual and perennial species of _Heliophila_, we calculated drought during different seasons at the location of observations for _Heliophila_ records using the VHI. Specifically, we created maps of the frequencies of observing drought conditions between years (VHI<40, NOAA) during the winter (quarter surrounding winter solstice), spring (quarter surrounding spring equinox), summer (quarter surrounding summer solstice) and autumn (quarter surrounding autumn equinox) from 1981 to 2015 across the range of _Heliophila_. From these maps, the drought frequency (the number of times drought is observed divided by the total number of years, 34) during the winter, spring, summer, and autumn were extracted for the locations of all GBIF records. 

### Filtering of occurrence records
```{r cleanup}
species_life_history<-read.csv("../data/Heliophila_life_history.csv")
species_life_history$species<-gsub("_", " ", species_life_history$species)
species_life_history$species <- as.factor(species_life_history$species)

GBIF <- GBIF %>%
  mutate(Winter=raster::extract(Winter, cbind(decimalLongitude, decimalLatitude))) %>%
  mutate(Spring=raster::extract(Spring, cbind(decimalLongitude, decimalLatitude))) %>%
  mutate(Summer=raster::extract(Summer, cbind(decimalLongitude, decimalLatitude))) %>%
  mutate(Autumn=raster::extract(Autumn, cbind(decimalLongitude, decimalLatitude))) %>%
  mutate(ymd_lat_lon_sp = paste0(year,"_",month,"_",day,"_", decimalLatitude,"_", decimalLongitude,"_", species))
  
GBIF_cleaned <- GBIF %>%
  filter(species %in% species_life_history$species) %>% 
  filter(!is.na(decimalLatitude)) %>%
  filter(hasGeospatialIssues==FALSE) %>%
  filter(decimalLatitude<(-20)) %>%
  filter(decimalLongitude<40) %>%
  filter(!duplicated(ymd_lat_lon_sp)) %>%
  merge(species_life_history) %>%
  filter(!is.na(Summer))
```

To avoid instances with spurious location data, we filtered raw GBIF records by restricting our analyses to include only:  

* records for species with reported life history  
* records with geospatial data  
* records without known geospatial coordinate issues (i.e., coordinates reported are those of herbarium)  
* records from collection sites classified as land pixels in the VHI dataset   
* records from Africa (to exclude locations of cultivation)
* records without duplicates (i.e., identical species, location, collection date)  

Out of `r nrow(GBIF)` _Heliophila_ GBIF records,  `r sum(GBIF$species %in% species_life_history$species)` were for species with reported life history [@mummenhoff2005phylogeny], `r sum((GBIF$species %in% species_life_history$species) & !is.na(GBIF$decimalLatitude))` had geospatial data, `r sum((GBIF$species %in% species_life_history$species) & !is.na(GBIF$decimalLatitude) & !(GBIF$hasGeospatialIssues==T) & !(is.na(GBIF$decimalLatitude)))` did not have geospatial issues, `r sum((GBIF$species %in% species_life_history$species) & !is.na(GBIF$decimalLatitude) & !(GBIF$hasGeospatialIssues==T) & !(is.na(GBIF$decimalLatitude)) & !(is.na(GBIF$Summer)) & !(is.na(GBIF$decimalLatitude)))` were located on pixels classified as land having drought measurements, `r sum(GBIF$decimalLatitude < (-20) & GBIF$decimalLongitude < (40) & !is.na(GBIF$decimalLatitude) & !(GBIF$hasGeospatialIssues==T) & (GBIF$species %in% species_life_history$species) & !(is.na(GBIF$Summer)))` were located in Africa, `r sum(!duplicated(GBIF$ymd_lat_lon_sp) & GBIF$decimalLatitude < (-20) & GBIF$decimalLongitude < (40) & !is.na(GBIF$decimalLatitude) & !(GBIF$hasGeospatialIssues==T) & (GBIF$species %in% species_life_history$species) & !(is.na(GBIF$Summer))) ` were not duplicated. 

### Phylogeny construction and ancestral state estimation
Outgroup ( _Aethionema grandiflorum, Alliaria petiolata, Cardamine matthioli, Chamira circaeoides_, and _Rorippa amphibia_) and ingroup _Heliophila_ ITS I and II sequences were aligned using MAFFT [@katoh2002mafft] with strategy G-INS-I, offset value 0.1, and all other options set as default. The $GTR + \Gamma$ model of nucleotide substitution was determined to best fit the data based on AIC using jModelTest2 [@darriba2012jmodeltest;@guindon2003a]. A maximum clade credibility tree with branch lengths as relative time was estimated by summarizing data from six runs of 100,000,000 generations of Bayesian Markov chain Monte Carlo conducted in BEAST 2 [@bouckaert2014beast]. Model selection and phylogenetic analyses were conducted through the CIPRES Science Gateway [@miller2010creating]. Ancestral state estimation was performed in R using the package phytools [@revell2012phytools] to generate 10,000 stochastic character maps simulated under an equal rates model of character evolution for the trait life habit (annual or perennial).

### Comparison of drought frequency between annual and perennial species
```{r speciesmeans}
species_means <- GBIF_cleaned %>%
  dplyr::select(species, life_history, Winter, Summer, Spring, Autumn) %>%
  group_by(species, life_history) %>%
  summarise(n=n(), Winter_mean=mean(Winter), Spring_mean=mean(Spring), Summer_mean=mean(Summer), Autumn_mean=mean(Autumn)) %>% 
  as.data.frame()

```


```{r phylomodels, results="hide"}
# phylogentic constraint
tree<-read.nexus("../data/TrimmedMCCwoPolytomies.nex")
tree<- rescale(tree, "depth", 1)
tree<-keep.tip(tree, tip = gsub(" ","_", as.character(species_means$species)))

species_means$life_history_num<-as.numeric(species_means$life_history)-1
row.names(species_means)<-gsub(" ", "_", species_means$species)
seasons<-c("Winter_mean", "Spring_mean", "Summer_mean","Autumn_mean")

phylomodelstable<-data.frame()

for(s in 1:length(seasons)){
  fit1 <-  phyloglm(species_means$life_history_num~species_means[,seasons[s]], data=species_means, phy=tree)
  sum<-summary(fit1)
  row.names(sum$coefficients)<-NULL
  sum_df<-data.frame(Predictor=c("Intercept", gsub("_mean", " drought freq.", seasons[s])), sum$coefficients)
  phylomodelstable<-rbind(phylomodelstable, sum_df)
}

phylomodelstable <- phylomodelstable[,c( "Predictor","Estimate","p.value")]

```
To evaluate the hypothesis that annual and perennial life history strategies reflect adaptations to alternative drought regimens, we tested the corresponding prediction that the observed distributions of annual and perennial _Heliophila_ species would be significantly associated with historic drought frequency. We  tested for a relationship between drought frequency and life history, season, and their interaction by analysis of variance while including species as a random effect using the lme4 package in R [@bates2014fitting] and compared annuals and perennials using Tukey adjusted post-hoc contrasts. We next calculated the mean drought frequency during the winter, spring, summer and autumn for each species.  Because shared evolutionary history of closely related species can lead to spurious associations between traits and environments  [@felsenstein1985phylogenies], we tested for a relationship between life history strategy and drought frequency while controlling for phylogeny using phylogenetic logistic regression [@ives2010phylogenetic]. This statistical approach is designed to control for the confounding effects of common ancestry's influence on demographic features such as geospatial relationships when addressing hypotheses about the role of natural selection on trait distributions.

### Collection dates

To test the hypothesis that annual species have adapted to escape drought prone seasons as seeds, collection dates for herbarium specimens were compared between annual and perennial species. Comparisons of distributions were made by Two-sample Kolmogorov-Smirnov test and Barlett variance test.

# Results
(ref:phylogeny) Species and examples of herbaria specimens of _Heliophila_ (a) Phylogeny and life history strategies of species studied. Orange circles at branch tips mark annual species and blue circles mark perennial species. At internal nodes, pie charts indicate the estimated posterior probability of being annual versus perennial. Example herbaria specimens accessed via GBIF of (b) _H. minima_, (c) _H. deserticola_, (d) _H. coronopifolia_ and (e) _H. ephemera_. Images (b,d,e) courtesy of The Bavarian Natural History Collections (CC BY-SA 4.0) and (c) The London  Natural History Museum (CC BY 4.0). Links to images are found in the supplement.

```{r makephylogeny, eval=T, message=F, warning="hide", results="hide"}

# source("../src/ancestral state.R") #uncomment to rerun the ancestral state reconstruction. Takes a few minutes.


pdf("../figures/phylogeny.pdf", height=5.5, width=4.5)

tree <- read.nexus("../data/TrimmedMCCwoPolytomies.nex")
ladderize(tree) -> tree
tree$tip.label<-gsub("_"," ", tree$tip.label)
rescale(tree, "depth", 1) -> tree

data <- read.csv("../data/species_means_table.csv", header=T)
data$A_P_num<-as.numeric(data$LH)-1

pies<-read.csv("../data/ancestral_state.csv")
treeplot<-ggtree(tree, layout = "rectangular")+
  xlim(c(0,2))+
  geom_tippoint(size=3,col=ifelse(data$A_P_num[match(tree$tip.label,data$Species)]=="0", "orange3", "dodgerblue3"))+
  geom_tiplab(offset = .05 , size=3)+
  theme(plot.background = element_rect(fill=alpha("white",0)))

treeplot<-inset(treeplot, nodepie(pies, cols = c("X0", "X1" ), color  = c("orange3", "dodgerblue3" )), width=2.7, height=2.7)


minima <- readPNG("../pictures/minima.png")
minima <- rasterGrob(minima, interpolate=TRUE)
#https://www.gbif.org/occurrence/1099023487

deserticola <- readPNG("../pictures/deserticola.png")
deserticola <- rasterGrob(deserticola, interpolate=TRUE)
#https://www.gbif.org/occurrence/1057389408

coronopifolia<-readPNG("../pictures/coronopifolia.png")
coronopifolia <- rasterGrob(coronopifolia, interpolate=TRUE)
#https://www.gbif.org/occurrence/1099023562

ephemera<-readPNG("../pictures/ephemera.png")
ephemera <- rasterGrob(ephemera, interpolate=TRUE)
#https://www.gbif.org/occurrence/1099023490

pics<-plot_grid(minima, deserticola, coronopifolia, ephemera,
                labels = c("b","c","d","e"), ncol = 1, hjust = -1)

plot_grid(treeplot, pics, ncol=2,labels=c("a",""), rel_widths = c(1.9,0.5))


dev.off()

```


```{r phylogeny, fig.cap='(ref:phylogeny)', out.width = "\\textwidth", fig.pos = "!h"}
knitr::include_graphics("../figures/phylogeny.pdf", dpi = 108)
```

(ref:mapsboxplots) Locations of occurrence records of (a) annual and (b) perennial _Heliophila._ Drought frequency during the (c) winter, (d) spring, (e) summer and (f) autumn detected using the VHI. (g) Drought frequencies during each season at the observation locations of annual and perennial _Heliophila_ (Post-hoc contrasts annuals and perennials from ANOVA, \*\* = p < 0.01). Boxplots indicate median (horizontal line), first and third quartiles (upper and lower limits of box), and 1.5 times the interquartile range (whiskers). Individual observations are shown by crosshairs. Annual and perennial species are indicated by data colored blue and oranage, respectively.

```{r make_maps_boxplots, eval=T, message=F, results="hide"}


pdf("../figures/maps_boxplots.pdf", width=4.5, height=7.2)
world <- map_data("world") # we already did this, but we can do it again

perennialmap<-ggplot() + geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  geom_point(GBIF_cleaned %>% filter(life_history=="p"), mapping=aes(x=decimalLongitude, y=decimalLatitude), pch=3, col="dodgerblue3", alpha=0.3) +
  theme_classic()+
  theme( text = element_text(size=8))+
  labs(title="Perennial species", x="Longitude (Â°)", y="Latitude (Â°)")+
  annotate("text", x=32, y=-34, label=paste("n obs. =", nrow(GBIF_cleaned %>% filter(life_history=="p"))), size=2)

annualmap<-ggplot() + geom_polygon(data = world, aes(x=long, y = lat, group=group),  lwd=.5, fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  geom_point(GBIF_cleaned %>% filter(life_history=="a"), mapping=aes(x=decimalLongitude, y=decimalLatitude), pch=3, col="orange3", alpha=0.3) +
  theme_classic()+
  theme(text = element_text(size=8))+
  labs(title="Annual species", x="Longitude (Â°)", y="Latitude (Â°)")+
  annotate("text", x=32, y=-34, label=paste("n obs. =", nrow(GBIF_cleaned %>% filter(life_history=="a"))), size=2)



col_scale<-c( 'white',"gray90", "gray10", 'black')
#col_scale<-c( "green4","green", "white","purple4","black")


Winter_SA <-crop(Winter, rbind(c(12,37),c(-35, -18)))

wintermap<-gplot(Winter_SA) + 
  geom_tile(aes(fill=value)) + 
  scale_fill_gradientn(colors=col_scale, na.value="white", name=NULL) +
  geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  theme_classic()+
  theme(legend.position = c(0.95,.3),legend.text=element_text(size=rel(0.7)), legend.key.size=unit(.4,"line"), legend.background = element_rect(fill=alpha('white', 0)), text = element_text(size=8))+
  labs(title="Winter drought freq.", x="Longitude (Â°)", y="Latitude (Â°)")

Spring_SA <-crop(Spring, rbind(c(12,37),c(-35, -18)))

springmap<-gplot(Spring_SA) + 
  geom_tile(aes(fill=value)) + 
  scale_fill_gradientn(colors=col_scale, na.value="white", name=NULL) +
  geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  theme_classic()+
  theme(legend.position = c(0.95,.3),legend.text=element_text(size=rel(0.7)), legend.key.size=unit(.4,"line"), legend.background = element_rect(fill=alpha('white', 0)), text = element_text(size=8))+
  labs(title="Spring drought freq.", x="Longitude (Â°)", y="Latitude (Â°)")

Summer_SA <-crop(Summer, rbind(c(12,37),c(-35, -18)))

summermap<-gplot(Summer_SA) + 
  geom_tile(aes(fill=value)) + 
  scale_fill_gradientn(colors=col_scale, na.value="white", name=NULL) +
  geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  theme_classic()+
  theme(legend.position = c(0.95,.3),legend.text=element_text(size=rel(0.7)), legend.key.size=unit(.4,"line"), legend.background = element_rect(fill=alpha('white', 0)), text = element_text(size=8))+
  labs(title="Summer drought freq.", x="Longitude (Â°)", y="Latitude (Â°)")

Fall_SA <-crop(Autumn, rbind(c(12,37),c(-35, -18)))

fallmap<-gplot(Fall_SA) + 
  geom_tile(aes(fill=value)) + 
  scale_fill_gradientn(colors=col_scale, na.value="white", name=NULL) +
  geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  theme_classic()+
  theme(legend.position = c(0.95,.3),legend.text=element_text(size=rel(0.7)), legend.key.size=unit(.4,"line"), legend.background = element_rect(fill=alpha('white', 0)), text = element_text(size=8))+
  labs(title="Autumn drought freq.", x="Longitude (Â°)", y="Latitude (Â°)")

GBIF_cleaned_long<- GBIF_cleaned %>%
  dplyr::select(species, life_history, Winter, Spring, Summer,Autumn) %>%
  gather(season, drought_freq, Winter, Spring, Summer,Autumn)

GBIF_cleaned_long$season<-factor(GBIF_cleaned_long$season, levels=c("Winter","Spring","Summer","Autumn"))

ann_text <- data.frame(x = 1.5,drought_freq = 0.8,life_history="a", lab = "**",
                       season = factor(c("Summer","Autumn"), levels=c("Winter","Spring","Summer","Autumn")))

boxplots<-ggplot(GBIF_cleaned_long, aes(x=life_history, col=life_history, y=drought_freq))+
  facet_wrap(~season, ncol=4 )+
  geom_jitter(width = .3, alpha=0.05, pch=3)+
  geom_boxplot(outlier.colour = "white", outlier.fill = NA, fill=NA, width=.3)+
  scale_color_manual(values=c("orange3","dodgerblue3"))+
  theme_classic()+
  theme(legend.position = "none", text = element_text(size=8))+
  scale_x_discrete(name="Life history", labels=c("Annual","Perennial"))+
  labs(y="Drought frequency")+
  geom_text(data=ann_text, label="**", col="black", nudge_x = 0.5, cex=4)


maps<-plot_grid(annualmap, 
          perennialmap, 
          wintermap, 
          springmap,
          summermap,
          fallmap, 
          labels = "auto", ncol = 2)
plot_grid(maps, boxplots, ncol=1,labels=c("","g"), rel_heights = c(.75,.35))


dev.off()

```

```{r mapsboxplots, fig.cap='(ref:mapsboxplots)', out.width = "\\textwidth", fig.pos = "!h"}
knitr::include_graphics("../figures/maps_boxplots.pdf", dpi = 108)
```

The topology of the estimated _Heliophila_ phylogeny was consistent with previous studies [@mummenhoff2005phylogeny;@mandakova2012whole]. Based on 10,000 stochastic character maps simulated under an equal rates model of character evolution in life history, an average of approximately seven changes from annual to perennial and five changes from perennial to annual are observed per stochastic character map (Figure \@ref(fig:phylogeny)a). These results suggest that the ancestral state of _Heliophila_ was annual and that both character states have arisen independently mutliple times.

After all filtering steps, `r nrow(GBIF_cleaned)` records for `r length(unique(GBIF_cleaned$species))` species (Figure \@ref(fig:phylogeny), Table \@ref(tab:speciesmeanstable)) passed for further analyses. The number of samples varied between species, with a mean of `r mean(species_means$n)` samples per species.  _H. rigidiuscula_ had the most records, `r max(species_means$n)`,  and  _H. cornellsbergia_ the fewest,  `r min(species_means$n)` (Table \@ref(tab:speciesmeanstable)).

There were clear visual differences between the distributions of the `r sum(GBIF_cleaned$life_history=="a")` annual and the `r sum(GBIF_cleaned$life_history=="p")` perennial _Heliophila_ observation records (Figure \@ref(fig:mapsboxplots), Figure \@ref(fig:speciesmaps)). While annual species were generally found in the western regions of South Africa and Namibia, primarily in the Cape Floristic Region and Succulent Karoo (Figure \@ref(fig:mapsboxplots)a), the occurrence of perennials extended to the southern and eastern coast of South Africa (Figure \@ref(fig:mapsboxplots)b). 

```{r anova, eval=T, message=F, warning="hide", results="hide"}

melted<-GBIF_cleaned %>% select(life_history, Winter, Spring, Summer,Autumn, species) %>% gather(Winter, Spring, Summer,Autumn, key="season",value="droughtfreq")

fit<-lmer(droughtfreq~life_history*season+(1|species), melted)
anovatable<-data.frame(predictor=c("life history","season","life history x season"), anova(fit))
colnames(anovatable)[7]<-"p-value"
row.names(anovatable)<-NULL

post_hoc<-emmeans(fit, list(pairwise ~ life_history*season), adjust = "tukey")
post_hoc<-as.data.frame(post_hoc$`pairwise differences of life_history, season`)
post_hoc<-post_hoc[c(1,14,23,28), ]
post_hoc$contrast<-c("Autumn","Spring","Summer","Winter")

```

The frequency of drought varied considerably across the ranges of _Heliophila_ species (Figure \@ref(fig:mapsboxplots)c-f). This heterogeneity is expected, given that this is one of the most climatically diverse regions of the Earth [@sayre2013new]. It is worth noting the east to west cline in drought frequency observed during the summer, which distinguishes the high drought frequency of the Kalahari Sands and Namid Desert phytogeographic regions from the low drought frequency of the Drakensberg Mountains and Coastal Zambesian phytogeographic regions. In the Cape phytogeographic region there was finer scale heterogeneity in drought frequency during the summer. 

We found that the frequency of drought was significantly higher at the locations of occurrence records for annual species. When comparing across all occurrence records (all records rather than species means, Figure \@ref(fig:mapsboxplots)g), a mixed-model analysis of variance which included species as random effect revealed a significant relationship between drought frequency and life history (p < 0.01), season (p < 0.01) and their interaction (p < 0.01) (Table \@ref(tab:anovatable)). Post-hoc contrasts showed that the frequency of drought was significantly higher at the location of annuals during the summer (z ratio = `r post_hoc$z.ratio[post_hoc$contrast=="Summer"]`, p = < 0.01), and autumn (z ratio = `r post_hoc$z.ratio[post_hoc$contrast=="Autumn"]`, p < 0.01).  Because a comparison across all occurrence records does not account for variation in the number of records per species (Table \@ref(tab:speciesmeanstable)) or species relatedness (Figure \@ref(fig:phylogeny)a), we also tested whether mean drought frequency values of each species were significantly different between annuals and perennials using phylogenetic logistic regression. We found that the mean drought frequencies were significantly higher ($\alpha = 0.05$) in annual species during the spring, summer, and autumn (Table \@ref(tab:modelstable), Figure \@ref(fig:lineplots)a,b). These findings indicate that common ancestry alone does not explain differences in the drought frequencies experienced between the environments of annual and perennial _Heliophila_.

```{r modelstable, results = 'asis', echo = F}

modelstable<-bind_cols(phylomodelstable)

modelstable<- phylomodelstable %>%
  dplyr::select(Predictor, Estimate, p.value) 

colnames(modelstable)<-c("Predictor", "Estimate","P")

apa_table(modelstable
  , caption = "Phylogenetic logistic regressions between life history, and the mean drought frequency observed at specimen sites of Heliophila species the winter, spring, summer, and autumn"
  , note = "Annual species were scored as 0 and perennial species as 1.",
  midrules=c(2,4,6,8),
  digits=4
)

```

(ref:lineplots) (a) Comparison (mean +- SE) of drought frequency across seasons calculated at the occurrence locations of GBIF records of annual and perennial species of _Heliophila_. (b) Results from phylogenetic logistic regression, where the line shows the model fit and \* = p < 0.05, \*\* = p < 0.01. Annuals were scored as 0 and perennials as 1.  (c) Collection dates of GBIF records of annual and perennial species of _Heliophila_ in relation to the photoperiodic calendar where day 1 is intermediate to the autumn equinox and winter solstice. 

```{r makelineplots, eval=T, message=F, results="hide", warning=F}

pdf("../figures/line_and_dates.pdf", height=6, width=5)

life_history_drought_means<- species_means %>% 
  dplyr::select(life_history, Winter_mean, Spring_mean, Summer_mean,Autumn_mean)  %>%
  gather(variable, value, -life_history) %>%
  group_by(life_history, variable) %>%
  summarise(mean = mean(value), se = sd(value)/sqrt(length(value))) %>%
  mutate(variable = reorder(variable, c(4,2,3,1)))

lines<-ggplot(life_history_drought_means, aes(x=life_history, col=life_history,group=life_history, y=mean))+
  theme_bw()+
  geom_point(size=2)+
  #geom_line(lwd=0.5, lty=1)+
  facet_grid(~variable, labeller = as_labeller(c("Winter_mean"="Winter","Spring_mean"="Spring","Summer_mean"="Summer","Autumn_mean"="Autumn")))+
  geom_errorbar(width=0.25,lwd=1, aes(ymin=mean-se, ymax=mean+se))+
  scale_y_continuous(limits=c(0.3,0.45), labels = c("0.300", "0.350", "0.400", "0.450"))+
  scale_x_discrete(labels=NULL)+
  scale_color_manual(values=c( "orange3","dodgerblue3"), name="Life history", labels=c("Annual", "Prennial"))+
  labs(x=NULL,y="Drought Frequency")+
  theme(axis.ticks.x =element_blank(), strip.background =element_rect(fill="white"))

GBIF_cleaned$date_calc<-as.Date(paste(
  GBIF_cleaned$month,
  GBIF_cleaned$day, sep="-"),"%m-%d")
GBIF_cleaned$days<-lubridate::yday(GBIF_cleaned$date_calc)
GBIF_cleaned$days_adjusted<-sapply(GBIF_cleaned$days, function(x)
  if(is.na(x)){ return(NA)
  }else if(x>135) {
    return (x-135)
  }else return (x+230))


dates<-ggplot(GBIF_cleaned %>% filter(is.finite(days_adjusted)), aes(x=days_adjusted, fill=life_history)) +
  geom_density(alpha=.5)+
  scale_fill_manual(values=c("orange3","dodgerblue3"), name="Life history", labels=c("Annual", "Perennial"))+
  theme_bw()+
  scale_x_continuous(name="Day of photoperiodic year", breaks=c(45,135,225, 315), labels=c("45\n(Winter)","135\n(Spring)","225\n(Summer)","315\n(Autumn)"))+
  labs(title="Timing of observation for occurrence records", y="Density")+
  theme( plot.title = element_text(hjust = 0.5, size=10))

tree<-read.nexus("../data/TrimmedMCCwoPolytomies.nex")
tree<- rescale(tree, "depth", 1)
tree<-keep.tip(tree, tip = gsub(" ","_", as.character(species_means$species)))

species_means$life_history_num<-as.numeric(species_means$life_history)-1
row.names(species_means)<-gsub(" ", "_", species_means$species)

fit <-  phyloglm(species_means$life_history_num~species_means$Spring_mean, data=species_means, phy=tree)
cc <- coef(fit)
spcurve<-plogis(cc[1]+cc[2]*sort(species_means$Spring_mean))

fit <-  phyloglm(species_means$life_history_num~species_means$Summer_mean, data=species_means, phy=tree)
cc <- coef(fit)
scurve<-plogis(cc[1]+cc[2]*sort(species_means$Summer_mean))

fit <-  phyloglm(species_means$life_history_num~species_means$Autumn_mean, data=species_means, phy=tree)
cc <- coef(fit)
fcurve<-plogis(cc[1]+cc[2]*sort(species_means$Autumn_mean))

fit <-  phyloglm(species_means$life_history_num~species_means$Winter_mean, data=species_means, phy=tree)
cc <- coef(fit)
wicurve<-plogis(cc[1]+cc[2]*sort(species_means$Winter_mean))

curvedataframe<-data.frame(
  droughtfreq=c(sort(species_means$Winter_mean),
                sort(species_means$Spring_mean),
                sort(species_means$Summer_mean),
                sort(species_means$Autumn_mean)),
  season=rep(c("Winter","Spring","Summer","Autumn"), each=42),
  curves=c(wicurve, spcurve, scurve, fcurve),
  lifehistory=c(species_means$life_history_num[order(species_means$Winter_mean)],
                species_means$life_history_num[order(species_means$Spring_mean)],
                species_means$life_history_num[order(species_means$Summer_mean)],
                species_means$life_history_num[order(species_means$Autumn_mean)])
                           )
curvedataframe$lifehistory<-curvedataframe$lifehistory
curvedataframe$season<-factor(curvedataframe$season, levels=c("Winter","Spring","Summer","Autumn"))

fit_stats<-data.frame(season=factor(c("Winter","Spring","Summer","Autumn"),levels=c("Winter","Spring","Summer","Autumn")), label=c("","*","**","**"), lifehistory="1")

fitplots<-ggplot(curvedataframe, aes(x=droughtfreq, col=as.factor(lifehistory), y=lifehistory))+
  geom_jitter(height = .03, width=0, alpha=0.7)+
  facet_grid(~season)+
  theme_bw()+
  scale_color_manual(values=c( "orange3","dodgerblue3"), name="Life history", labels=c("Annual", "Prennial"))+  scale_y_continuous(breaks = c(0,1), labels=c("       a","       p"))+
  geom_line(aes(x=droughtfreq, y=curves), col="black")+
  theme(axis.text.x = element_text(angle=90), strip.background = element_rect(fill="white"))+
labs(y="Life history", x="Drought frequency")+
  geom_text(data=fit_stats, aes(x=.4, y=.75, label=label), col="black", cex=5)

plot_grid(lines, fitplots, dates, ncol=1, labels="auto", rel_heights = c(1,1.2,1.5))

annuals<-subset(GBIF_cleaned, life_history=="a")
perennials<-subset(GBIF_cleaned, life_history=="p")

kout<-ks.test(annuals$days,perennials$days)
tout<-t.test(days~life_history, GBIF_cleaned)
bout<-bartlett.test(days~life_history, GBIF_cleaned)

dev.off()

```

```{r lineplots, fig.cap='(ref:lineplots)', out.width = "\\textwidth", fig.pos = "!h"}
knitr::include_graphics("../figures/line_and_dates.pdf", dpi = 108)
```

The preceding results indicate that annual species are found in environments where droughts are significantly more frequent, especially in the summer and autumn. Classic life history theory hypothesizes that annuality reflects adaptation to such environments because it allows species to escape predictable stressful conditions. If this is the case, we would expect that annuals spend the drought prone seasons of summer and autumn as seeds. To test this hypothesis, we compared the dates of occurrence records between annual and perennial _Heliophila_ species. The distributions reveal a considerable difference in the timing of observation of these two life histories. In comparison to perennials, which appear to be collected throughout the year, annuals are almost exclusively observed during the winter and spring (Figure \@ref(fig:lineplots)b). The differences between the distribution of collection dates were significant by all tests (ks.test D = `r  kout$statistic`, p < 0.01; bartlett.test K2 = `r bout$statistic`, p < 0.01) This is consistent with a model of life history in which annual species flower in the spring, set seed, senesce, and die before the summer. Thus, these annual species are likely to remain dormant during the summer and autumn, when drought is the strongest predictor of the distributions of annual and perennial life histories (Figure \@ref(fig:lineplots)a).  


# Discussion

To test the hypothesis that annual and perennial plants reflect adaptation to alternative drought environments we examined the distributions of life history strategies in the large and diverse mustard genus, _Heliophila_. Using metadata of `r nrow(GBIF_cleaned)` occurrence records and a 34 year dataset of satellite-detected droughts, we tested the prediction that annual species are more often observed in drought-prone locations than perennial species, when controlling for phylogenetic relatedness. We found that drought frequency is significantly different between the distributions of annual and perennial species, with annuals being found in environments with more frequent drought, and that this signal is strongest during the seasons when annuals are likely escaping via seed dormancy. These results remain significant while controlling for the phylogenetic relationships of _Heliophila_ species, yielding support for the role that natural selection has played in driving contemporary distributions of these alternatives strategies in relation to drought regimens.

We cannot eliminate the possibility that confounding traits or environmental variables are the causative factors explaining variation in the distributions of annual and perennial species. Nevertheless, these results provide quantitative support for the classic prediction that annual species are found in environments that experience more frequent drought than perennial species, building on previous investigations of associations between life history and climate [@evans2005climate;@morishima1984differentiation;@datson2008climate; @cruz2009molecular]. To our knowledge this is the first study to demonstrate a significant association between life history and drought in a phylogenetic context informed by large scale species distribution data and long term drought detection. 

Unfortunately, herbarium collections and their associated data do not represent systematic or random sampling of a species distribution. Significant biases in collecting exist, which we have not necessarily controlled for here, and may have some effect on our findings, such as a bias toward collecting near roads or near the locations of natural history collections [@daru2018widespread]. Future research will benefit from systematic sampling efforts to avoid these noted biases. However, the ecosystems of southern Africa include several biodiversity hotspots and are among the most botanically well sampled regions on Earth [@daru2018widespread], suggesting that this may currently be the optimal region for our analyses of life history distribution. Indeed, we were able to use `r nrow(GBIF_cleaned)` occurrence records to study 42 species, which represents a significant advance over relying on personal observations to characterize species distributions. 

These findings empirically  support classical theoretical predictions about the adaptive value of annual and perennial life history strategies. Taken together, they suggest that in _Heliophila_, annual species are adapted to environments with predictable droughts by escaping drought prone seasons during the dormant seed phase of their life cycle. They also suggest that perenniality is adaptive in environments where droughts are less frequent. While most previous work has focused on describing the evolutionary origins of annuality [@barrett1996comparative;@conti1999phylogenetic;@andreasen2001unequal;@verboom2004testing;@friedman2015all] there are at least a few other cases where perenniality appears to have arisen from an annual ancestor [@bena1998molecular;@tank2008annuals]. And while early theory predicted selection for annuality when adult mortality is high [@stearns1992evolution],  we also find evidence that perenniality could be explained by reduced frequency of drought. This is supported by the theoretical prediction that perenniality is advantageous in stable habitats. The phylogeny reveals several transitions from annual to perennial life history (Figure \@ref(fig:phylogeny)a) and the distributions of perennial _Heliophila_ extend into regions where drought frequency is low (Figure \@ref(fig:mapsboxplots)b, Figure \@ref(fig:speciesmaps)).  Perennials may be able to out compete annual relatives in environments where the infrequency of drought favors strategies that allow plants to benefit from growth over many seasons. This also suggests that annuals rely on drought as a source of disturbance for seedling recruitment when competing with perennials [@corbin2004competition]. Indeed, no annual species were observed in the low drought regions of eastern South Africa (Figure \@ref(fig:mapsboxplots), Figure \@ref(fig:speciesmaps)).

These findings suggest that species with locally adaptive life history strategies could be threatened by rapidly changing drought regimens [@dai2011drought]. In light of the findings here, forecasted reductions in rainfall across eastern South Africa [@south2017a] could be particularly impactful to plant community compositions. Here we found that this region is currently dominated by derived perennial species of _Heliophila_. However, a scenario in which droughts become more frequent in this region may allow for the establishment of annuals. Such changes in selection patterns and shifts in plant functional diversity could have impacts on ecosystem functioning and processes such as carbon cycling [@garnier1997specific; @roumet2006suites;@monroe2018ecoevolutionary]. Furthermore, the changes in frequency of drought may be an important factor when considering the use of perennial cropping systems [@parry2005prospects;@lelievre2009current].  

In conclusion, we find strong support for classic life history theory that predicts that annuality is adaptive in environments with frequent and predictable droughts. We report evidence consistent with a life history model in annuals in which they escape drought prone seasons during the seed phase of their life cycle. We also find evidence that the distributions of perennial lineages may indicate a competitive advantage in areas where droughts are infrequent. More broadly, this work highlights the irreplaceable value of natural history collections and demonstrates the power of combining such information with large scale remote sensing data to address outstanding classic hypotheses in ecology and evolution.

# Acknowledgments 
We thank Jesse Lasky, members of the Sloan lab, and three anonymous reviewers for generous feedback that improved the quality of this work. This research was supported by NSF Award 1701918 and USDA-NIFA Award 2014-38420-21801 to JGM.

# Author contributions

JGM, BG, KGT and JKM contributed to the design of the research, interpretation, and writing the manuscript. JGM, BG, and KGT contributed to the performance of the research and data analysis.


# References

```{r create_r-references}
#r_refs(file = "r-references.bib")
```
\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id = "refs"></div>
\endgroup

\newpage
\beginsupplement

# Supplement 

### Notes S1
Images of herbarium specimens in Figure 1. Used under creative commons licenses, permissions not required. 
https://www.gbif.org/occurrence/1099023487  
https://www.gbif.org/occurrence/1057389408  
https://www.gbif.org/occurrence/1099023562  
https://www.gbif.org/occurrence/1099023490  

  
### Supplementary tables and figures  
\newpage

```{r speciesmeanstable, results = 'asis', echo = F}
species_means_table<-species_means
row.names(species_means_table) <- NULL
species_means_table<-species_means_table %>% dplyr::select(-life_history_num)
colnames(species_means_table)<-c("Species","LH","n","Winter","Spring","Summer","Autumn")
apa_table(
  species_means_table
  , caption = "Heliophila species records and the mean drought frequencies during different seasons at the location of records "
  , note = "LH = Life history (a = annual, p = perennial). n=sample size of GBIF records. Seasons are mean drought frequencies observed at locations of records.",
  digits=2,
  font_size="small",
  longtable = TRUE
)

write.csv(species_means_table, "../data/species_means_table.csv")
```

```{r anovatable, results='asis', echo = F}
apa_table(anovatable
          , caption = "Analysis of variance (ANOVA) to compare drought frequency as a function of life history, season, and their interaction while including species as a random effect.",
          note = "Type III Analysis of Variance Table with Satterthwaite's method",
          digits=4
)
```


(ref:mapsdroughtexamples) Example years experiencing contrasting degrees of drought in southern Africa. Vegetative Health Index (VHI) values below 40 indicate remotely sensed drought. Drought detection during these years is validated by previously reported precipitation based estimates of drought ocurrence [@monyela2017two] which confirm that while (a) 2015 was one of the worst drought years on record, (b) 1999 was one of the wettest, and (c) 2012 was typical in terms of precipitation patterns. It is worth noting that drought can be detected using the VHI across ecosystems, including those inhabited by perennial rather than annual _Heliophila_ species.


```{r make_drought_examples, results = 'hide', echo = F, warnings="hide"}
pdf("../figures/maps_drought_examples.pdf", width=3, height=6)

world <- map_data("world") # we already did this, but we can do it again
col_scale<-c("white","black")

drought<-raster::raster("~/VHI/raster/VHP.G16.C07.npp.P2015050.VH.nc.grd")
drought <-crop(drought, rbind(c(12,37),c(-35, -18)))

summer2015<-gplot(drought) + 
  geom_tile(aes(fill=value<4000)) + 
  scale_fill_manual(values = col_scale,  na.translate = F, name="VHI < 40") +
  geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  theme_classic()+
   theme(legend.position = c(1,.3),legend.text=element_text(size=rel(0.6)), legend.title = element_text(size=rel(0.6)), legend.key.size=unit(.2,"line"), legend.background = element_rect(fill=alpha('gray90'), color = "black"), text = element_text(size=8))+
  labs(title="VHI detected drought \n during summer 2015", x="Longitude (Â°)", y="Latitude (Â°)")

nondrought<-raster::raster("~/VHI/raster/VHP.G16.C07.NJ.P1999050.VH.hdf.h5.grd")
nondrought <-crop(nondrought, rbind(c(12,37),c(-35, -18)))

summer1999<-gplot(nondrought) + 
  geom_tile(aes(fill=value<4000)) + 
  scale_fill_manual(values = col_scale,  na.translate = F, name="VHI < 40") +
  geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  theme_classic()+
  theme(legend.position = c(1,.3),legend.text=element_text(size=rel(0.6)), legend.title = element_text(size=rel(0.6)), legend.key.size=unit(.2,"line"), legend.background = element_rect(fill=alpha('gray90'), color = "black"), text = element_text(size=8))+
  labs(title="VHI detected drought \n during summer 1999", x="Longitude (Â°)", y="Latitude (Â°)")

typical<-raster::raster("~/VHI/raster/VHP.G16.C07.NP.P2012050.VH.hdf.h5.grd")
typical <-crop(typical, rbind(c(12,37),c(-35, -18)))

summer2012<-gplot(typical) + 
  geom_tile(aes(fill=value<4000)) + 
  scale_fill_manual(values = col_scale,  na.translate = F, name="VHI < 40") +
  geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
  coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
  theme_classic()+
  theme(legend.position = c(1,.3),legend.text=element_text(size=rel(0.6)), legend.title = element_text(size=rel(0.6)), legend.key.size=unit(.2,"line"), legend.background = element_rect(fill=alpha('gray90'), color = "black"), text = element_text(size=8))+
  labs(title="VHI detected drought \n during summer 2012", x="Longitude (Â°)", y="Latitude (Â°)")

plot_grid(summer2015, 
          summer1999,
          summer2012, 
          labels = "auto", ncol = 1)


dev.off()

```

```{r mapsdroughtexamples, fig.cap='(ref:mapsdroughtexamples)'}
knitr::include_graphics("../figures/maps_drought_examples.pdf", dpi = 108)
```

(ref:speciesmaps) Maps of occurrence records for individual species. Orange points indicate annual species. Blue points indicate perennial species.

```{r make_spceiesmaps, results = 'hide', echo = F, warnings="hide"}
pdf("../figures/speciesmaps.pdf", height=8, width=8)

world <- map_data("world") # we already did this, but we can do it again

plot_grid(plotlist=lapply(unique(GBIF_cleaned$species), function(x){
  
  lh<-unique((GBIF_cleaned %>% filter(species==x))$life_history)
  lh_col=ifelse(lh=="a", "orange3", "dodgerblue3")
  
  ggplot() + geom_polygon(data = world, aes(x=long, y = lat, group=group),  fill = NA, color = "black") + 
    coord_fixed(xlim=c(13,35), ylim=c(-35, -22)) + 
    geom_point(GBIF_cleaned %>% filter(species==x), mapping=aes(x=decimalLongitude, y=decimalLatitude), pch=3, col=lh_col, alpha=0.3) +
    theme_classic()+
    theme( text = element_text(size=5))+
    labs(title=x, x=NULL, y=NULL)
  
}), ncol=6)

dev.off()

```

```{r speciesmaps, fig.cap='(ref:speciesmaps)'}
knitr::include_graphics("../figures/speciesmaps.pdf", dpi = 108)
```
